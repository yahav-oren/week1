name: Exercise-01-tests-workflow

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  Exercise-01-tests-workflow:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Cache and Install Valgrind
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: valgrind
          version: 1.0

      - name: Prerequisite Setup
        run: |
          git clone https://$GH_PAT@github.com/Cyber-Education-Center/ExerciseTests-Utils.git/ utils
          cd utils
          g++ printMessage.cpp -o printMessage
          chmod +x printMessage
          mv printMessage ..
          mv CodesToMessages.csv ..
          cd ..
          rm -rf utils

          git clone https://$GH_PAT@github.com/Cyber-Education-Center/ExerciseTests-ValgrindVarifier.git valgrindvarifierDIR
          cd valgrindvarifierDIR && g++ ValgrindVarifier.cpp -o valgrindverifier && chmod +x valgrindverifier && mv valgrindverifier .. && cd ..
          
          git clone https://$GH_PAT@github.com/Cyber-Education-Center/ExerciseTests-Ex01.git ex1
          mv ex1/* .
          rm -rf ex1 .git .github valgrindvarifierDIR
          cat <<EOF > results.json
          {
            "grades": {
              "part1": 0,
              "part2": 0
            }
          }
          EOF
        env:
          GH_PAT: ${{ secrets.GIT_TOKEN }}

      - name: Verify Submission Files
        run: |
          git clone https://$GH_PAT@github.com/Cyber-Education-Center/ExerciseTests-VerifySubmittedFiles.git verifysubmittedfiles
          cd verifysubmittedfiles
          go build .
          chmod +x filesverifier
          mv filesverifier ..
          cd .. && rm -rf verifysubmittedfiles
          ./filesverifier PreSubmissionChecker.txt 5
          ./filesverifier PreSubmissionChecker.txt 2
          ./filesverifier PreSubmissionChecker.txt 4
        env:
          GH_PAT: ${{ secrets.GIT_TOKEN }}

      - name: Compile and Test Part 1
        run: |
          ./filesverifier Part1Checker.txt 1
          mkdir -p temp123
          mv Ex1Part1Test.cpp temp123/
          cd temp123
          g++ Queue.cpp Ex1Part1Test.cpp -o exec1
          mv exec1 ..
          cd ..
          chmod +x exec1
          if ./exec1 1 && ./exec1 2; then score=40; else score=0; fi
          jq ".grades.part1 = $score" results.json > tmp.json && mv tmp.json results.json

      - name: Memory Check Part 1
        run: |
          valgrind --leak-check=yes --log-file=valgrind-out1.txt ./exec1 1
          ./valgrindverifier valgrind-out1.txt && score=-1 || score=0
          valgrind --leak-check=yes --log-file=valgrind-out2.txt ./exec1 2
          ./valgrindverifier valgrind-out2.txt && score=score-1 || score=0

      - name: Compile and Test Part 2
        run: |
          ./filesverifier Part2Checker.txt 1
          mkdir -p temp123
          mv Ex1Part2Test.cpp temp123/
          cd temp123
          g++ Stack.cpp Utils.cpp LinkedList.cpp Ex1Part2Test.cpp -o exec2
          mv exec2 ..
          cd ..
          chmod +x exec2
          if ./exec2 1 && ./exec2 2 && ./exec2 3; then score=60; else score=0; fi
          jq ".grades.part2 = $score" results.json > tmp.json && mv tmp.json results.json

      - name: Memory Check Part 2
        run: |
          valgrind --leak-check=yes --log-file=valgrind-out21.txt ./exec2 1
          ./valgrindverifier valgrind-out21.txt && score=-1 || score=0
          valgrind --leak-check=yes --log-file=valgrind-out22.txt ./exec2 2
          ./valgrindverifier valgrind-out22.txt && score=score-1 || score=0
          valgrind --leak-check=yes --log-file=valgrind-out23.txt ./exec2 3
          ./valgrindverifier valgrind-out23.txt && score=score-1 || score=0

      - name: Summary
        if: always()
        run: |
          echo "All tests completed."
          total=$(jq '[.grades.part1, .grades.part2] | add' results.json)
          avg=$(jq -n "($total / 100 * 100) | round")
          echo "Final score: $avg% ($total out of 100)"
          echo -n "Final results.json:"; cat results.json | tr -d '\n'
